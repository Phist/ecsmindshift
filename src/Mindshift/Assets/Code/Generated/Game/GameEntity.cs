//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by Entitas.CodeGeneration.Plugins.EntityGenerator.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------

using System;
using System.Linq;
using System.Text;
using Assets.Code;
using Assets.Code.Components;
using Assets.Code.Services;
using DesperateDevs.Utils;
using Assets.Code.Extensions;
using Entitas;

public sealed partial class GameEntity : Entitas.Entity
{
  private string _oldBaseToStringCache;
  private string _toStringCache;
  private StringBuilder _toStringBuilder;

  public override string ToString()
  {
    InvalidateCache();

    if (_toStringCache == null)
    {
      if (_toStringBuilder == null)
        _toStringBuilder = new StringBuilder();

      _toStringBuilder.Length = 0;

      IComponent[] components = GetComponents();

      if (components.Length == 0) // do not set _toStringCache this time since components seem to be initialized later o_O
        return "No components";

      _toStringBuilder.Append($"{EntityName(components)} (");

      int num = components.Length - 1;

      for (int index = 0; index < components.Length; ++index)
      {
        IComponent component = components[index];
        Type type = component.GetType();

        _toStringBuilder.Append(type.GetMethod(nameof(ToString)).DeclaringType.ImplementsInterface<IComponent>()
          ? component.ToString()
          : type.Name.RemoveComponentSuffix());

        if (index < num)
          _toStringBuilder.Append(", ");
      }

      _toStringBuilder.Append($")(*{retainCount})");
      _toStringCache = _toStringBuilder.ToString();

      _oldBaseToStringCache = base.ToString();
    }

    return _toStringCache;
  }

  private void InvalidateCache()
  {
    if (_oldBaseToStringCache != base.ToString())
      _toStringCache = null;
  }

  private string EntityName(IComponent[] components)
  {
    try
    {
      if (components.Length == 1)
        return components[0].GetType().Name;
      
      foreach (IComponent component in components)
      {
        if (component is IService)
          return component.GetType().Name;
        
        switch (component.GetType().Name)
        {
          case nameof(Assets.Code.Components.Hero):
            return Hero();
          case nameof(Assets.Code.Components.SpriteRendererComponent):
            return SpriteRenderer.gameObject.name;
        }
      }
    }
    catch (Exception exception)
    {
      Contexts.sharedInstance.game.Logger.LogMessage(exception.Message);
    }
    
    return components[0].GetType().Name;
  }

  private string Hero() =>
    new StringBuilder($"Hero ")
      .Do(s => s.Append($"Grounded "), when: isGrounded)
      .Do(s => s.Append($"{CurrentHp}/{MaxHp} "), when: hasCurrentHp && hasMaxHp)
      .ToString();

  private bool AnyWith(string name, IComponent[] @in) => 
    @in.Any(x => x.GetType().Name == name);
}
